<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
		PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
		"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.demo.board.mapper.PostMapper">
	<resultMap id="postMap" type="com.example.demo.board.Post">
		<id column="post_id" property="id"/>
		<result column="post_title" property="title"/>
		<result column="post_content" property="content"/>
		<result column="post_created_at" property="createdAt"/>
		<result column="post_updated_at" property="updatedAt"/>
		<association property="operatorUser"
				javaType="com.example.demo.board.OperatorUser"
				notNullColumn="operator_user_id">
			<id column="operator_user_id" property="id"/>
			<result column="operator_user_username" property="username"/>
			<result column="operator_user_email" property="email"/>
			<result column="operator_user_password_hash" property="passwordHash"/>
			<result column="operator_user_created_at" property="createdAt"/>
			<result column="operator_user_updated_at" property="updatedAt"/>
		</association>
	</resultMap>

	<select id="selectAll" resultMap="postMap">
		SELECT
			b.id AS post_id,
			b.title AS post_title,
			b.content AS post_content,
			b.created_at AS post_created_at,
			b.updated_at AS post_updated_at,
			b.operator_user_id AS operator_user_id,
			ou.username AS operator_user_username,
			ou.email AS operator_user_email,
			ou.password_hash AS operator_user_password_hash,
			ou.created_at AS operator_user_created_at,
			ou.updated_at AS operator_user_updated_at
		FROM board b
		LEFT JOIN operator_user ou ON b.operator_user_id = ou.id
		ORDER BY b.created_at DESC
	</select>

	<select id="selectById" resultMap="postMap">
		SELECT
			b.id AS post_id,
			b.title AS post_title,
			b.content AS post_content,
			b.created_at AS post_created_at,
			b.updated_at AS post_updated_at,
			b.operator_user_id AS operator_user_id,
			ou.username AS operator_user_username,
			ou.email AS operator_user_email,
			ou.password_hash AS operator_user_password_hash,
			ou.created_at AS operator_user_created_at,
			ou.updated_at AS operator_user_updated_at
		FROM board b
		LEFT JOIN operator_user ou ON b.operator_user_id = ou.id
		WHERE b.id = #{id}
	</select>

	<select id="insert" parameterType="com.example.demo.board.Post" resultMap="postMap">
		WITH inserted AS (
			INSERT INTO board (
				operator_user_id,
				title,
				content,
				created_at,
				updated_at
			) VALUES (
				#{operatorUser.id},
				#{title},
				#{content},
				now(),
				now()
			)
			RETURNING id, operator_user_id, title, content, created_at, updated_at
		)
		SELECT
			inserted.id AS post_id,
			inserted.title AS post_title,
			inserted.content AS post_content,
			inserted.created_at AS post_created_at,
			inserted.updated_at AS post_updated_at,
			inserted.operator_user_id AS operator_user_id,
			ou.username AS operator_user_username,
			ou.email AS operator_user_email,
			ou.password_hash AS operator_user_password_hash,
			ou.created_at AS operator_user_created_at,
			ou.updated_at AS operator_user_updated_at
		FROM inserted
		LEFT JOIN operator_user ou ON inserted.operator_user_id = ou.id
	</select>

	<select id="update" parameterType="com.example.demo.board.Post" resultMap="postMap">
		WITH updated AS (
			UPDATE board
			SET
				title = #{title},
				content = #{content},
				operator_user_id = #{operatorUser.id},
				updated_at = now()
			WHERE id = #{id}
			RETURNING id, operator_user_id, title, content, created_at, updated_at
		)
		SELECT
			updated.id AS post_id,
			updated.title AS post_title,
			updated.content AS post_content,
			updated.created_at AS post_created_at,
			updated.updated_at AS post_updated_at,
			updated.operator_user_id AS operator_user_id,
			ou.username AS operator_user_username,
			ou.email AS operator_user_email,
			ou.password_hash AS operator_user_password_hash,
			ou.created_at AS operator_user_created_at,
			ou.updated_at AS operator_user_updated_at
		FROM updated
		LEFT JOIN operator_user ou ON updated.operator_user_id = ou.id
	</select>

	<delete id="delete">
		DELETE FROM board
		WHERE id = #{id}
	</delete>
</mapper>
